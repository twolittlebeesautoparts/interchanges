<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>JB Parts Interchange</title>

<style>
:root{
  --bg:#070b12; --panel:#0b1220; --card:#0f1a2e; --card2:#0b1526;
  --text:#f5f7fb; --muted:#a7b0c0; --accent:#f4c430; --accent2:#ffb703;
  --ok:#22c55e; --bad:#ff5d5d; --warn:#ffcc66; --line:rgba(255,255,255,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(900px 500px at 20% -10%, #1f2937, transparent), var(--bg);
  color:var(--text);
}
header{
  position:sticky; top:0; z-index:10;
  background:rgba(7,11,18,.85);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.header-inner{
  max-width:1200px; margin:auto; padding:16px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand{display:flex; align-items:center; gap:12px;}
.logo{
  width:42px; height:42px; border-radius:12px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  display:grid; place-items:center; color:#000; font-weight:900;
  box-shadow:0 10px 30px rgba(244,196,48,.18);
}
.brand h1{margin:0;font-size:16px;letter-spacing:.3px}
.brand .sub{margin-top:2px;font-size:12px;color:var(--muted)}
.pill{
  border:1px solid var(--line); background:rgba(15,26,46,.7);
  color:var(--text); padding:10px 12px; border-radius:999px;
  font-weight:800; cursor:pointer;
}
.pill.primary{border:none;color:#000;background:linear-gradient(180deg,var(--accent),var(--accent2));}
main{
  max-width:1200px; margin:auto; padding:18px;
  display:grid; grid-template-columns: 1.25fr .95fr; gap:14px;
}
@media (max-width: 980px){ main{grid-template-columns:1fr} }
.card{
  background:linear-gradient(180deg, rgba(15,26,46,.9), rgba(11,21,38,.9));
  border:1px solid var(--line); border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.35); overflow:hidden;
}
.card .top{
  padding:14px 14px 10px; border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.card .top h2{margin:0;font-size:14px;letter-spacing:.6px}
.card .content{padding:14px}
.grid{display:grid; grid-template-columns:repeat(12,1fr); gap:10px;}
.field{grid-column:span 3}
.field.wide{grid-column:span 6}
.field.full{grid-column:span 12}
@media (max-width: 820px){
  .field{grid-column:span 6}
  .field.wide{grid-column:span 12}
}
label{display:block; font-size:11px; color:var(--muted); margin:0 0 6px 2px;}
input,select,textarea{
  width:100%; padding:12px; border-radius:14px;
  border:1px solid var(--line); background:#071021; color:var(--text); outline:none;
}
textarea{min-height:110px; resize:vertical}
.actions{display:flex; gap:10px; align-items:center;}
.actions .pill{flex:1}
.note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}
.results{margin-top:12px;display:grid;gap:10px}
.result{
  background:#071021; border:1px solid var(--line);
  border-radius:14px; padding:12px; border-left:4px solid var(--ok);
}
.result.bad{border-left-color:var(--bad)}
.result.warn{border-left-color:var(--warn)}
.badge{
  display:inline-flex; gap:8px; align-items:center; font-size:11px;
  padding:4px 10px; border-radius:999px; border:1px solid var(--line);
  background:rgba(34,197,94,.12); color:var(--ok); font-weight:800;
}
.badge.bad{background:rgba(255,93,93,.12);color:var(--bad)}
.badge.warn{background:rgba(255,204,102,.12);color:var(--warn)}
.small{font-size:12px;color:var(--muted)}
.hr{height:1px;background:var(--line);margin:12px 0}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:16px; z-index:999; background:#071021;
  border:1px solid var(--line); padding:10px 14px;
  border-radius:999px; color:var(--text); display:none;
}
.locked{opacity:.35; filter:saturate(.8); pointer-events:none;}
.modalWrap{
  position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px;
}
.modal{
  width:min(520px, 95vw);
  background:linear-gradient(180deg, rgba(15,26,46,.98), rgba(11,21,38,.98));
  border:1px solid var(--line); border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,.6); overflow:hidden;
}
.modalTop{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;}
.modalTop h3{margin:0;font-size:14px;letter-spacing:.6px}
.modalBody{padding:14px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:520px){.row2{grid-template-columns:1fr}}
.err{color:var(--bad);font-size:12px;margin-top:10px;display:none}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">JB</div>
      <div>
        <h1>JB Parts Interchange</h1>
        <div class="sub">GitHub Pages + Firestore • VIN Decode • Bulk Import • OEM / Engine / Trans Codes</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="small" id="status">Connecting…</span>
      <button class="pill" type="button" onclick="openAdmin()">Admin</button>
    </div>
  </div>
</header>

<div class="toast" id="toast">Saved ✅</div>

<main>
  <!-- SEARCH -->
  <section class="card">
    <div class="top">
      <h2>AUTO PARTS INTERCHANGE</h2>
      <span class="small">Type values • Suggestions load from Firestore</span>
    </div>

    <div class="content">
      <div class="grid">
        <div class="field wide">
          <label>VIN (optional)</label>
          <input id="vin" placeholder="Enter 17-digit VIN" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="pill primary" type="button" onclick="decodeVIN()">Decode VIN</button>
        </div>

        <div class="field">
          <label>Year</label>
          <input id="year" list="yearsList" placeholder="2020" inputmode="numeric" />
          <datalist id="yearsList"></datalist>
        </div>

        <div class="field">
          <label>Make</label>
          <input id="make" list="makesList" placeholder="Toyota" />
          <datalist id="makesList"></datalist>
        </div>

        <div class="field">
          <label>Model</label>
          <input id="model" list="modelsList" placeholder="Camry" />
          <datalist id="modelsList"></datalist>
        </div>

        <div class="field">
          <label>Part</label>
          <input id="part" list="partsList" placeholder="Battery" />
          <datalist id="partsList"></datalist>
        </div>

        <div class="field wide">
          <label>OEM Part Number (optional but BEST)</label>
          <input id="oem" placeholder="Example: 28800-0H050" />
        </div>

        <div class="field full">
          <button class="pill primary" type="button" onclick="findInterchange()">Find Interchange</button>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="note">
        This tool does NOT auto-know interchanges. You store them from: OEM part numbers, your yard knowledge,
        catalogs, returns, and verified matches. It will show warnings for risky parts.
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section class="card" id="adminCard">
    <div class="top">
      <h2>ADMIN – ADD / UPDATE</h2>
      <span class="small">Locked until login</span>
    </div>

    <div class="content">
      <div id="adminLockedNote" class="result bad">
        <span class="badge bad">Admin locked</span>
        <div style="margin-top:8px">Click <b>Admin</b> top-right and login to edit.</div>
      </div>

      <div id="adminBody" class="locked">
        <div class="grid">
          <div class="field">
            <label>Year</label>
            <input id="ayear" placeholder="2020" inputmode="numeric" />
          </div>
          <div class="field">
            <label>Make</label>
            <input id="amake" placeholder="Ford" />
          </div>
          <div class="field">
            <label>Model</label>
            <input id="amodel" placeholder="F150" />
          </div>

          <div class="field">
            <label>Trim (optional)</label>
            <input id="atrim" placeholder="LE / XLT / Sport..." />
          </div>

          <div class="field">
            <label>Body (optional)</label>
            <input id="abody" placeholder="Sedan / SUV / Coupe..." />
          </div>

          <div class="field">
            <label>Engine Code (optional)</label>
            <input id="aengine" placeholder="2AR-FE / K24A / Coyote..." />
          </div>

          <div class="field">
            <label>Transmission Code (optional)</label>
            <input id="atrans" placeholder="Aisin U760E / 6R80..." />
          </div>

          <div class="field">
            <label>Part</label>
            <input id="apart" placeholder="Battery / Engine / Headlight..." />
          </div>

          <div class="field wide">
            <label>OEM Part Number (optional)</label>
            <input id="aoem" placeholder="OEM part # if known" />
          </div>

          <div class="field full">
            <label>Interchange list (one per line)</label>
            <textarea id="ainterchange" placeholder="Example:
2018–2023 Toyota Camry (Group 24F)
2019–2022 Toyota RAV4 (Group 24F)"></textarea>
          </div>

          <div class="field full">
            <label>Notes / Fitment rules (optional)</label>
            <textarea id="anotes" placeholder="Example: Must match 24F group size. Check terminals."></textarea>
          </div>

          <div class="field full actions">
            <button class="pill primary" type="button" onclick="saveVehiclePart()">Save Vehicle / Part</button>
            <button class="pill" type="button" onclick="seedExample()">Seed Example</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- BULK IMPORT -->
        <div class="result warn">
          <span class="badge warn">Bulk Import</span>
          <div class="small" style="margin-top:8px">
            Paste lines like:<br>
            <code>2020|Toyota|Camry|Battery|28800-0H050|2018–2023 Camry Group 24F</code><br>
            <code>2018|Ford|F150|Engine||2018–2020 F150 5.0L Coyote Gen 3</code>
          </div>
        </div>

        <textarea id="bulk" placeholder="One per line:
year|make|model|part|oem(optional)|interchange line
year|make|model|part|oem(optional)|interchange line"></textarea>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="pill primary" type="button" onclick="bulkImport()">Bulk Import</button>
          <button class="pill" type="button" onclick="bulkTemplate()">Insert Template</button>
        </div>

        <div class="hr"></div>
        <div class="note">
          ⚠️ Your username/password lock is client-side only (not real security). For real security, you’d use Firebase Auth + rules.
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Admin login modal -->
<div class="modalWrap" id="adminModal">
  <div class="modal">
    <div class="modalTop">
      <h3>Admin Login</h3>
      <button class="pill" type="button" onclick="closeAdmin()">Close</button>
    </div>
    <div class="modalBody">
      <div class="row2">
        <div>
          <label>Username</label>
          <input id="adminUser" placeholder="username" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="adminPass" type="password" placeholder="password" autocomplete="current-password" />
        </div>
      </div>

      <div class="err" id="adminErr">Wrong username or password.</div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="pill primary" type="button" onclick="adminLogin()">Login</button>
        <button class="pill" type="button" onclick="adminLogout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, updateDoc, limit
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ✅ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDZOxfCjD9kAZJDlVLRT_enhXXZCC3GlH0",
    authDomain: "jb-parts-interchanges.firebaseapp.com",
    projectId: "jb-parts-interchanges",
    storageBucket: "jb-parts-interchanges.firebasestorage.app",
    messagingSenderId: "117852934482",
    appId: "1:117852934482:web:4991c3d36378e011a0aa8b",
    measurementId: "G-4ZPC6KHM3N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== DOM
  const statusEl = document.getElementById("status");
  const toastEl = document.getElementById("toast");
  const resultsEl = document.getElementById("results");

  // Search
  const yearEl = document.getElementById("year");
  const makeEl = document.getElementById("make");
  const modelEl = document.getElementById("model");
  const partEl = document.getElementById("part");
  const oemEl  = document.getElementById("oem");
  const vinEl  = document.getElementById("vin");

  // Lists
  const yearsList = document.getElementById("yearsList");
  const makesList = document.getElementById("makesList");
  const modelsList = document.getElementById("modelsList");
  const partsList = document.getElementById("partsList");

  // Admin
  const adminBody = document.getElementById("adminBody");
  const adminLockedNote = document.getElementById("adminLockedNote");
  const ayear = document.getElementById("ayear");
  const amake = document.getElementById("amake");
  const amodel = document.getElementById("amodel");
  const atrim = document.getElementById("atrim");
  const abody = document.getElementById("abody");
  const aengine = document.getElementById("aengine");
  const atrans = document.getElementById("atrans");
  const apart = document.getElementById("apart");
  const aoem = document.getElementById("aoem");
  const ainterchange = document.getElementById("ainterchange");
  const anotes = document.getElementById("anotes");
  const bulkEl = document.getElementById("bulk");

  // Admin modal
  const adminModal = document.getElementById("adminModal");
  const adminUser = document.getElementById("adminUser");
  const adminPass = document.getElementById("adminPass");
  const adminErr = document.getElementById("adminErr");

  // ===== Quick lock (NOT true security)
  const ADMIN_USER = "blas2025";
  const ADMIN_PASS = "1520";

  // Big parts list (editable anytime)
  const ALL_PARTS = [
    "Engine","Transmission","Transfer Case","Differential","Axle","Drive Shaft",
    "Battery","Alternator","Starter","Fuse Box","ECU/PCM","TCM","BCM",
    "Radiator","Condenser","Cooling Fan","Water Pump","Thermostat","Heater Core",
    "A/C Compressor","A/C Line","Power Steering Pump","Steering Rack","Steering Column",
    "Brake Caliper","Brake Master Cylinder","ABS Module","Brake Booster",
    "Wheel","Wheels","Tire","Tires","Rim","Hub","Wheel Bearing",
    "Headlight","Taillight","Fog Light","Mirror","Door","Door Handle","Window Regulator","Glass",
    "Bumper","Fender","Hood","Trunk Lid","Tailgate","Grille","Quarter Panel",
    "Seat","Seat Belt","Airbag","Dash","Instrument Cluster","Radio","Navigation Screen",
    "Catalytic Converter","Muffler","O2 Sensor","Exhaust Manifold",
    "Throttle Body","Intake Manifold","Fuel Pump","Fuel Injector","Fuel Tank",
    "Strut","Shock","Control Arm","Ball Joint","Tie Rod","Sway Bar"
  ];

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    setTimeout(()=>toastEl.style.display="none", 1800);
  }
  function norm(s){ return String(s||"").trim().replace(/\s+/g," ").toLowerCase(); }
  function titleCaseKeepDigits(s){
    const parts = String(s||"").trim().split(/\s+/);
    return parts.map(p=>{
      if(/[0-9]/.test(p)) return p.toUpperCase();
      return p.charAt(0).toUpperCase()+p.slice(1).toLowerCase();
    }).join(" ");
  }
  function vehicleId(year, make, model, trim=""){
    // trim included so you can separate LE vs XLE if you want
    const base = `${year}_${norm(make)}_${norm(model)}_${norm(trim)}`.replace(/[^a-z0-9_]/g,"");
    return base.replace(/_+$/,"");
  }
  function fillDatalist(dl, values){
    dl.innerHTML = "";
    [...new Set(values)].filter(Boolean).forEach(v=>{
      const o=document.createElement("option");
      o.value = v;
      dl.appendChild(o);
    });
  }
  function showResult(html){ resultsEl.innerHTML = html; }

  function partRiskLevel(partName){
    const p = norm(partName);
    if(["airbag","seat belt","abs module","ecu/pcm","bcm","tcm"].some(x=>p.includes(x))) return "danger";
    if(["engine","transmission","differential","axle"].some(x=>p.includes(x))) return "warn";
    return "safe";
  }

  async function ping(){
    try{
      await getDocs(query(collection(db,"vehicles"), limit(1)));
      statusEl.textContent = "Connected ✅";
    }catch(e){
      console.error(e);
      statusEl.textContent = "Firestore blocked ❌";
      showResult(`<div class="result bad"><span class="badge bad">Permission</span><div style="margin-top:8px">Firestore rules are blocking reads. In Firebase Console → Firestore → Rules, allow read for testing.</div></div>`);
    }
  }

  async function loadYears(){
    try{
      const snap = await getDocs(collection(db,"vehicles"));
      const years = snap.docs.map(d=>d.data()?.year).filter(v=>typeof v==="number").sort((a,b)=>a-b).map(String);
      fillDatalist(yearsList, years);
    }catch(e){ console.error(e); }
  }
  async function loadMakes(){
    const y = Number(yearEl.value);
    if(!y) return;
    const snap = await getDocs(query(collection(db,"vehicles"), where("year","==", y)));
    const makes = snap.docs.map(d=>d.data()?.make).filter(Boolean).map(titleCaseKeepDigits);
    fillDatalist(makesList, makes);
  }
  async function loadModels(){
    const y = Number(yearEl.value);
    const mk = makeEl.value.trim();
    if(!y || !mk) return;
    const snap = await getDocs(query(collection(db,"vehicles"), where("year","==", y), where("make","==", mk)));
    const models = snap.docs.map(d=>d.data()?.model).filter(Boolean).map(titleCaseKeepDigits);
    fillDatalist(modelsList, models);
  }

  async function findInterchange(){
    resultsEl.innerHTML = "";

    const y  = Number(yearEl.value);
    const mk = makeEl.value.trim();
    const md = modelEl.value.trim();
    const pt = partEl.value.trim();
    const oem = (oemEl.value||"").trim();

    if(!y || !mk || !md || !pt){
      showResult(`<div class="result bad"><span class="badge bad">Missing</span><div style="margin-top:8px">Type Year, Make, Model, Part.</div></div>`);
      return;
    }

    // 1) If OEM provided, search by OEM first (strongest match)
    if(oem){
      const oq = query(collection(db,"oem_index"), where("oem","==", oem), where("part","==", pt), limit(20));
      const os = await getDocs(oq);
      if(!os.empty){
        const hits = os.docs.map(d=>d.data());
        const risk = partRiskLevel(pt);
        const warnBadge = risk==="danger"
          ? `<span class="badge bad">High Risk Part</span>`
          : risk==="warn" ? `<span class="badge warn">Verify Codes</span>` : `<span class="badge">OEM Match</span>`;

        resultsEl.innerHTML = `
          <div class="result ${risk==="danger"?"bad":risk==="warn"?"warn":""}">
            ${warnBadge}
            <div style="margin-top:8px" class="small">OEM: <b>${oem}</b> • Part: <b>${pt}</b></div>
          </div>
        `;
        hits.forEach(h=>{
          const div=document.createElement("div");
          div.className="result";
          div.innerHTML = `<b>${h.year}</b> ${h.make} ${h.model} ${h.trim||""} <span class="small">(${h.body||""})</span>`;
          resultsEl.appendChild(div);
        });
        return;
      }
    }

    // 2) Otherwise search the vehicle doc
    const qv = query(collection(db,"vehicles"),
      where("year","==", y),
      where("make","==", mk),
      where("model","==", md),
      limit(1)
    );

    const snap = await getDocs(qv);
    if(snap.empty){
      showResult(`<div class="result bad"><span class="badge bad">No data</span><div style="margin-top:8px">No record found. Add it in Admin.</div></div>`);
      return;
    }

    const data = snap.docs[0].data();
    const list = data?.parts?.[pt];

    const risk = partRiskLevel(pt);
    const warnMsg = risk==="danger"
      ? `<div class="small" style="margin-top:6px">⚠️ High-risk part. Don’t sell without verifying exact numbers/codes.</div>`
      : risk==="warn"
        ? `<div class="small" style="margin-top:6px">⚠️ Verify engine/trans codes + options before confirming fit.</div>`
        : "";

    if(!Array.isArray(list) || list.length===0){
      showResult(`<div class="result bad"><span class="badge bad">No interchange</span><div style="margin-top:8px">No list saved for <b>${pt}</b>.</div>${warnMsg}</div>`);
      return;
    }

    resultsEl.innerHTML = `
      <div class="result ${risk==="danger"?"bad":risk==="warn"?"warn":""}">
        <span class="badge">${risk==="danger"?"Stored Match":"Found"}</span>
        <div style="margin-top:8px" class="small">${y} ${mk} ${md} • ${pt}</div>
        ${warnMsg}
      </div>
    `;
    list.forEach(item=>{
      const div = document.createElement("div");
      div.className = "result";
      div.textContent = item;
      resultsEl.appendChild(div);
    });

    if(data?.notes?.[pt]){
      const div=document.createElement("div");
      div.className="result warn";
      div.innerHTML = `<span class="badge warn">Notes</span><div style="margin-top:8px">${String(data.notes[pt]).replace(/\n/g,"<br>")}</div>`;
      resultsEl.appendChild(div);
    }
  }

  async function decodeVIN(){
    const v = (vinEl.value||"").trim().toUpperCase();
    if(v.length !== 17){ toast("Enter a 17-digit VIN"); return; }

    showResult(`<div class="result"><span class="badge">Decoding…</span><div style="margin-top:8px">Looking up VIN with NHTSA.</div></div>`);
    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${v}?format=json`);
    const d = (await r.json()).Results?.[0] || {};

    const y = d.ModelYear ? String(d.ModelYear) : "";
    const mk = d.Make ? titleCaseKeepDigits(d.Make) : "";
    const md = d.Model ? titleCaseKeepDigits(d.Model) : "";

    if(!y || !mk || !md){
      showResult(`<div class="result bad"><span class="badge bad">Decode failed</span><div style="margin-top:8px">Year/Make/Model missing from VIN response.</div></div>`);
      return;
    }

    yearEl.value = y;
    await loadMakes();
    makeEl.value = mk;
    await loadModels();
    modelEl.value = md;

    showResult(`<div class="result"><span class="badge">VIN OK</span><div style="margin-top:8px">${y} ${mk} ${md}</div></div>`);
  }

  function ensureAdmin(){
    const ok = localStorage.getItem("jb_admin_ok") === "1";
    if(ok){
      adminBody.classList.remove("locked");
      adminLockedNote.style.display = "none";
    }else{
      adminBody.classList.add("locked");
      adminLockedNote.style.display = "block";
    }
    return ok;
  }

  async function upsertOEMIndex({year,make,model,trim,body,part,oem}){
    if(!oem) return;
    const id = `${norm(oem)}_${norm(part)}_${vehicleId(year,make,model,trim)}`;
    const ref = doc(db, "oem_index", id);
    await setDoc(ref, { oem, part, year, make, model, trim:trim||"", body:body||"" }, { merge:true });
  }

  async function saveVehiclePart(){
    if(!ensureAdmin()){ toast("Admin locked"); return; }

    const y = Number((ayear.value||"").trim());
    const mk = titleCaseKeepDigits(amake.value);
    const md = titleCaseKeepDigits(amodel.value);
    const tr = (atrim.value||"").trim();
    const bd = (abody.value||"").trim();
    const ec = (aengine.value||"").trim();
    const tc = (atrans.value||"").trim();
    const pt = (apart.value||"").trim();
    const oem = (aoem.value||"").trim();

    const lines = (ainterchange.value||"").split("\n").map(s=>s.trim()).filter(Boolean);
    const notes = (anotes.value||"").trim();

    if(!y || !mk || !md || !pt || lines.length===0){
      toast("Fill Year/Make/Model/Part + Interchange lines");
      return;
    }

    const id = vehicleId(y, mk, md, tr);
    const ref = doc(db, "vehicles", id);
    const snap = await getDoc(ref);

    if(!snap.exists()){
      await setDoc(ref, {
        year:y, make:mk, model:md, trim:tr||"", body:bd||"",
        engineCode:ec||"", transCode:tc||"",
        parts:{ [pt]: lines },
        oem:{ [pt]: oem||"" },
        notes:{ [pt]: notes||"" }
      });
    }else{
      const existing = snap.data() || {};
      const parts = existing.parts || {};
      const oemMap = existing.oem || {};
      const notesMap = existing.notes || {};
      parts[pt] = lines;
      oemMap[pt] = oem||"";
      notesMap[pt] = notes||"";
      await updateDoc(ref, {
        year:y, make:mk, model:md, trim:tr||"", body:bd||"",
        engineCode:ec||"", transCode:tc||"",
        parts, oem:oemMap, notes:notesMap
      });
    }

    await upsertOEMIndex({year:y,make:mk,model:md,trim:tr,body:bd,part:pt,oem});

    toast("Saved ✅");
    yearEl.value = String(y);
    await loadMakes(); makeEl.value = mk;
    await loadModels(); modelEl.value = md;
    partEl.value = pt;
    oemEl.value = oem;

    await loadYears();
  }

  async function bulkImport(){
    if(!ensureAdmin()){ toast("Admin locked"); return; }

    const raw = (bulkEl.value||"").trim();
    if(!raw){ toast("Paste bulk lines first"); return; }

    const lines = raw.split("\n").map(l=>l.trim()).filter(Boolean);
    let ok=0, bad=0;

    for(const line of lines){
      // year|make|model|part|oem(optional)|interchange line
      const parts = line.split("|");
      if(parts.length < 5){ bad++; continue; }
      const year = Number(parts[0]);
      const make = titleCaseKeepDigits(parts[1]);
      const model = titleCaseKeepDigits(parts[2]);
      const part = parts[3].trim();
      const oem = (parts[4]||"").trim();
      const interchange = (parts.slice(5).join("|")||"").trim(); // allow pipes inside text
      if(!year || !make || !model || !part || !interchange){ bad++; continue; }

      // save as single interchange line appended/merged
      const id = vehicleId(year, make, model, "");
      const ref = doc(db, "vehicles", id);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        await setDoc(ref, {
          year, make, model, trim:"", body:"",
          engineCode:"", transCode:"",
          parts:{ [part]: [interchange] },
          oem:{ [part]: oem },
          notes:{ [part]: "" }
        });
      }else{
        const d = snap.data() || {};
        const map = d.parts || {};
        const oemMap = d.oem || {};
        if(!Array.isArray(map[part])) map[part] = [];
        if(!map[part].includes(interchange)) map[part].push(interchange);
        if(oem && !oemMap[part]) oemMap[part] = oem;
        await updateDoc(ref, { parts:map, oem:oemMap });
      }

      await upsertOEMIndex({year,make,model,trim:"",body:"",part,oem});
      ok++;
    }

    toast(`Bulk import: ${ok} ok, ${bad} skipped`);
    await loadYears();
  }

  function bulkTemplate(){
    bulkEl.value = [
      "2020|Toyota|Camry|Battery|28800-0H050|2018–2023 Toyota Camry (Group 24F)",
      "2020|Toyota|Camry|Battery|28800-0H050|2019–2022 Toyota RAV4 (Group 24F)",
      "2018|Ford|F150|Engine||2018–2020 Ford F150 5.0L Coyote Gen 3",
      "2018|Ford|F150|Engine||2017–2019 Ford Expedition 5.0L Coyote Gen 3"
    ].join("\n");
    toast("Template added");
  }

  async function seedExample(){
    if(!ensureAdmin()){ toast("Admin locked"); return; }

    ayear.value = "2020";
    amake.value = "Toyota";
    amodel.value = "Camry";
    atrim.value = "LE";
    abody.value = "Sedan";
    aengine.value = "A25A-FKS";
    atrans.value = "U760E";
    apart.value = "Battery";
    aoem.value = "28800-0H050";
    ainterchange.value = [
      "2018–2023 Toyota Camry (Group 24F) — verify terminals",
      "2019–2022 Toyota RAV4 (Group 24F) — verify terminals"
    ].join("\n");
    anotes.value = "Match group size + terminal orientation. Check CCA requirements.";
    await saveVehiclePart();

    toast("Seeded ✅");
  }

  function openAdmin(){
    adminModal.style.display = "flex";
    adminErr.style.display = "none";
    adminUser.value = "";
    adminPass.value = "";
    adminUser.focus();
  }
  function closeAdmin(){ adminModal.style.display = "none"; }
  function adminLogin(){
    const u = (adminUser.value||"").trim();
    const p = (adminPass.value||"").trim();
    if(u === ADMIN_USER && p === ADMIN_PASS){
      localStorage.setItem("jb_admin_ok", "1");
      adminErr.style.display = "none";
      closeAdmin();
      ensureAdmin();
      toast("Admin unlocked ✅");
      document.getElementById("adminCard").scrollIntoView({behavior:"smooth", block:"start"});
      return;
    }
    adminErr.style.display = "block";
  }
  function adminLogout(){
    localStorage.removeItem("jb_admin_ok");
    ensureAdmin();
    toast("Logged out");
  }

  // expose
  window.findInterchange = findInterchange;
  window.decodeVIN = decodeVIN;
  window.saveVehiclePart = saveVehiclePart;
  window.seedExample = seedExample;
  window.bulkImport = bulkImport;
  window.bulkTemplate = bulkTemplate;
  window.openAdmin = openAdmin;
  window.closeAdmin = closeAdmin;
  window.adminLogin = adminLogin;
  window.adminLogout = adminLogout;

  // Suggestions
  yearEl.addEventListener("input", loadMakes);
  makeEl.addEventListener("input", loadModels);

  // Modal close
  adminModal.addEventListener("click", (e)=>{ if(e.target === adminModal) closeAdmin(); });

  // Init parts list
  fillDatalist(partsList, ALL_PARTS);

  // Init
  await ping();
  await loadYears();
  ensureAdmin();
</script>

</body>
</html>
