<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>JB Parts Interchange</title>

<style>
:root{
  --bg:#070b12;
  --panel:#0b1220;
  --card:#0f1a2e;
  --card2:#0b1526;
  --text:#f5f7fb;
  --muted:#a7b0c0;
  --accent:#f4c430;
  --accent2:#ffb703;
  --ok:#22c55e;
  --bad:#ff5d5d;
  --line:rgba(255,255,255,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(900px 500px at 20% -10%, #1f2937, transparent), var(--bg);
  color:var(--text);
}
header{
  position:sticky; top:0; z-index:10;
  background:rgba(7,11,18,.85);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.header-inner{
  max-width:1100px;
  margin:auto;
  padding:16px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand{
  display:flex; align-items:center; gap:12px;
}
.logo{
  width:42px; height:42px; border-radius:12px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  display:grid; place-items:center;
  color:#000; font-weight:900;
  box-shadow:0 10px 30px rgba(244,196,48,.18);
}
.brand h1{margin:0;font-size:16px;letter-spacing:.3px}
.brand .sub{margin-top:2px;font-size:12px;color:var(--muted)}
.pill{
  border:1px solid var(--line);
  background:rgba(15,26,46,.7);
  color:var(--text);
  padding:10px 12px;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.pill.primary{
  border:none;
  color:#000;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
}
main{
  max-width:1100px;
  margin:auto;
  padding:18px;
  display:grid;
  grid-template-columns: 1.4fr .9fr;
  gap:14px;
}
@media (max-width: 980px){ main{grid-template-columns:1fr} }
.card{
  background:linear-gradient(180deg, rgba(15,26,46,.9), rgba(11,21,38,.9));
  border:1px solid var(--line);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.35);
  overflow:hidden;
}
.card .top{
  padding:14px 14px 10px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.card .top h2{margin:0;font-size:14px;letter-spacing:.6px}
.card .content{padding:14px}
.grid{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:10px;
}
.field{grid-column:span 3}
.field.wide{grid-column:span 6}
.field.full{grid-column:span 12}
@media (max-width: 820px){
  .field{grid-column:span 6}
  .field.wide{grid-column:span 12}
}
label{
  display:block;
  font-size:11px;
  color:var(--muted);
  margin:0 0 6px 2px;
}
input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#071021;
  color:var(--text);
  outline:none;
}
textarea{min-height:110px; resize:vertical}
.actions{
  display:flex;
  gap:10px;
  align-items:center;
}
.actions .pill{flex:1}
.note{
  font-size:12px;
  color:var(--muted);
  margin-top:10px;
  line-height:1.35;
}
.results{margin-top:12px;display:grid;gap:10px}
.result{
  background:#071021;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  border-left:4px solid var(--ok);
}
.result.bad{border-left-color:var(--bad)}
.badge{
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(34,197,94,.12);
  color:var(--ok);
  font-weight:800;
}
.badge.bad{background:rgba(255,93,93,.12);color:var(--bad)}
.small{font-size:12px;color:var(--muted)}
.hr{height:1px;background:var(--line);margin:12px 0}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:16px; z-index:999;
  background:#071021;
  border:1px solid var(--line);
  padding:10px 14px;
  border-radius:999px;
  color:var(--text);
  display:none;
}

/* Admin lock overlay */
.locked{
  opacity:.35;
  filter:saturate(.8);
  pointer-events:none;
}
.modalWrap{
  position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.modal{
  width:min(520px, 95vw);
  background:linear-gradient(180deg, rgba(15,26,46,.98), rgba(11,21,38,.98));
  border:1px solid var(--line);
  border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,.6);
  overflow:hidden;
}
.modalTop{
  padding:14px 14px 10px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modalTop h3{margin:0;font-size:14px;letter-spacing:.6px}
.modalBody{padding:14px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:520px){.row2{grid-template-columns:1fr}}
.err{color:var(--bad);font-size:12px;margin-top:10px;display:none}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">JB</div>
      <div>
        <h1>JB Parts Interchange</h1>
        <div class="sub">GitHub Pages + Firestore • VIN Decode • Admin Add/Update</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="small" id="status">Connecting…</span>
      <button class="pill" type="button" onclick="openAdmin()">Admin</button>
    </div>
  </div>
</header>

<div class="toast" id="toast">Saved ✅</div>

<main>
  <!-- SEARCH -->
  <section class="card">
    <div class="top">
      <h2>AUTO PARTS INTERCHANGE</h2>
      <span class="small">Type anything • Suggestions load from Firestore</span>
    </div>

    <div class="content">
      <div class="grid">
        <div class="field wide">
          <label>VIN (optional)</label>
          <input id="vin" placeholder="Enter 17-digit VIN" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="pill primary" type="button" onclick="decodeVIN()">Decode VIN</button>
        </div>

        <!-- Typeable inputs + datalists -->
        <div class="field">
          <label>Year</label>
          <input id="year" list="yearsList" placeholder="2020" inputmode="numeric" />
          <datalist id="yearsList"></datalist>
        </div>

        <div class="field">
          <label>Make</label>
          <input id="make" list="makesList" placeholder="Toyota" />
          <datalist id="makesList"></datalist>
        </div>

        <div class="field">
          <label>Model</label>
          <input id="model" list="modelsList" placeholder="Camry" />
          <datalist id="modelsList"></datalist>
        </div>

        <div class="field">
          <label>Part</label>
          <input id="part" list="partsList" placeholder="Battery" />
          <datalist id="partsList">
            <option value="Engine"></option>
            <option value="Transmission"></option>
            <option value="Wheels"></option>
            <option value="Battery"></option>
            <option value="Alternator"></option>
            <option value="Starter"></option>
            <option value="Radiator"></option>
            <option value="Headlight"></option>
            <option value="Door"></option>
            <option value="Bumper"></option>
          </datalist>
        </div>

        <div class="field full">
          <button class="pill primary" type="button" onclick="findInterchange()">Find Interchange</button>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="note">
        If it says permission denied, you must allow Firestore reads/writes in Rules.
        This runs on GitHub Pages just fine — Firestore rules are what block it.
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section class="card" id="adminCard">
    <div class="top">
      <h2>ADMIN – ADD / UPDATE VEHICLE</h2>
      <span class="small">Locked until login</span>
    </div>

    <div class="content">
      <div id="adminLockedNote" class="result bad">
        <span class="badge bad">Admin locked</span>
        <div style="margin-top:8px">Click <b>Admin</b> top-right and login to edit vehicles.</div>
      </div>

      <div id="adminBody" class="locked">
        <div class="grid">
          <div class="field">
            <label>Year</label>
            <input id="ayear" placeholder="2020" inputmode="numeric" />
          </div>
          <div class="field">
            <label>Make</label>
            <input id="amake" placeholder="Ford" />
          </div>
          <div class="field">
            <label>Model</label>
            <input id="amodel" placeholder="F150" />
          </div>
          <div class="field">
            <label>Part</label>
            <input id="apart" list="partsList" placeholder="Engine" />
          </div>

          <div class="field full">
            <label>Interchange list (one per line)</label>
            <textarea id="ainterchange" placeholder="Example:
2018–2020 Ford F150 5.0L
2017–2019 Ford Expedition 5.0L
2018–2021 Mustang 5.0L"></textarea>
          </div>

          <div class="field full actions">
            <button class="pill primary" type="button" onclick="saveVehiclePart()">Save Vehicle / Part</button>
            <button class="pill" type="button" onclick="seedExample()">Seed Example Data</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="note">
          ⚠️ This “username/password lock” is a quick client-side lock (not true security).
          If you want real protection, say <b>lock admin for real</b> and I’ll set up Firebase Auth + strict Firestore rules.
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Admin login modal -->
<div class="modalWrap" id="adminModal">
  <div class="modal">
    <div class="modalTop">
      <h3>Admin Login</h3>
      <button class="pill" type="button" onclick="closeAdmin()">Close</button>
    </div>
    <div class="modalBody">
      <div class="row2">
        <div>
          <label>Username</label>
          <input id="adminUser" placeholder="username" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="adminPass" type="password" placeholder="password" autocomplete="current-password" />
        </div>
      </div>

      <div class="err" id="adminErr">Wrong username or password.</div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="pill primary" type="button" onclick="adminLogin()">Login</button>
        <button class="pill" type="button" onclick="adminLogout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    limit
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ✅ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDZOxfCjD9kAZJDlVLRT_enhXXZCC3GlH0",
    authDomain: "jb-parts-interchanges.firebaseapp.com",
    projectId: "jb-parts-interchanges",
    storageBucket: "jb-parts-interchanges.firebasestorage.app",
    messagingSenderId: "117852934482",
    appId: "1:117852934482:web:4991c3d36378e011a0aa8b",
    measurementId: "G-4ZPC6KHM3N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== DOM
  const statusEl = document.getElementById("status");
  const toastEl = document.getElementById("toast");
  const resultsEl = document.getElementById("results");

  // Search inputs
  const yearEl = document.getElementById("year");
  const makeEl = document.getElementById("make");
  const modelEl = document.getElementById("model");
  const partEl = document.getElementById("part");
  const vinEl = document.getElementById("vin");

  // Datalists
  const yearsList = document.getElementById("yearsList");
  const makesList = document.getElementById("makesList");
  const modelsList = document.getElementById("modelsList");

  // Admin body
  const adminBody = document.getElementById("adminBody");
  const adminLockedNote = document.getElementById("adminLockedNote");

  const ayear = document.getElementById("ayear");
  const amake = document.getElementById("amake");
  const amodel = document.getElementById("amodel");
  const apart = document.getElementById("apart");
  const ainterchange = document.getElementById("ainterchange");

  // Admin modal
  const adminModal = document.getElementById("adminModal");
  const adminUser = document.getElementById("adminUser");
  const adminPass = document.getElementById("adminPass");
  const adminErr = document.getElementById("adminErr");

  // ===== Quick lock (NOT true security)
  // User requested:
  // username: blas2025
  // password: 1520
  const ADMIN_USER = "blas2025";
  const ADMIN_PASS = "1520";

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    setTimeout(()=>toastEl.style.display="none", 1800);
  }

  function norm(s){
    return String(s||"").trim().replace(/\s+/g," ").toLowerCase();
  }
  function titleCaseKeepDigits(s){
    const parts = String(s||"").trim().split(/\s+/);
    return parts.map(p=>{
      if(/[0-9]/.test(p)) return p.toUpperCase();
      return p.charAt(0).toUpperCase()+p.slice(1).toLowerCase();
    }).join(" ");
  }

  function vehicleId(year, make, model){
    return `${year}_${norm(make)}_${norm(model)}`.replace(/[^a-z0-9_]/g,"");
  }

  function fillDatalist(dl, values){
    dl.innerHTML = "";
    [...new Set(values)].filter(Boolean).forEach(v=>{
      const o=document.createElement("option");
      o.value = v;
      dl.appendChild(o);
    });
  }

  function showResult(html){
    resultsEl.innerHTML = html;
  }

  async function ping(){
    try{
      await getDocs(query(collection(db,"vehicles"), limit(1)));
      statusEl.textContent = "Connected ✅";
    }catch(e){
      console.error(e);
      statusEl.textContent = "Firestore blocked ❌";
      showResult(`<div class="result bad"><span class="badge bad">Permission</span><div style="margin-top:8px">Firestore rules are blocking reads. In Firebase Console → Firestore → Rules, allow read for testing.</div></div>`);
    }
  }

  async function loadYears(){
    try{
      const snap = await getDocs(collection(db,"vehicles"));
      const years = snap.docs.map(d=>d.data()?.year)
        .filter(v=>typeof v==="number")
        .sort((a,b)=>a-b)
        .map(String);
      fillDatalist(yearsList, years);
    }catch(e){
      console.error(e);
    }
  }

  async function loadMakes(){
    // Only load suggestions if a year is typed
    const y = Number(yearEl.value);
    if(!y) return;
    const snap = await getDocs(query(collection(db,"vehicles"), where("year","==", y)));
    const makes = snap.docs.map(d=>d.data()?.make).filter(Boolean).map(titleCaseKeepDigits);
    fillDatalist(makesList, makes);
  }

  async function loadModels(){
    const y = Number(yearEl.value);
    const mk = makeEl.value.trim();
    if(!y || !mk) return;
    const snap = await getDocs(query(
      collection(db,"vehicles"),
      where("year","==", y),
      where("make","==", mk)
    ));
    const models = snap.docs.map(d=>d.data()?.model).filter(Boolean).map(titleCaseKeepDigits);
    fillDatalist(modelsList, models);
  }

  async function findInterchange(){
    resultsEl.innerHTML = "";

    const y  = Number(yearEl.value);
    const mk = makeEl.value.trim();
    const md = modelEl.value.trim();
    const pt = partEl.value.trim();

    if(!y || !mk || !md || !pt){
      showResult(`<div class="result bad"><span class="badge bad">Missing</span><div style="margin-top:8px">Pick / type Year, Make, Model, Part.</div></div>`);
      return;
    }

    const qv = query(
      collection(db,"vehicles"),
      where("year","==", y),
      where("make","==", mk),
      where("model","==", md),
      limit(1)
    );

    const snap = await getDocs(qv);

    if(snap.empty){
      showResult(`<div class="result bad"><span class="badge bad">No data</span><div style="margin-top:8px">No record found. Add it in Admin.</div></div>`);
      return;
    }

    const data = snap.docs[0].data();
    const list = data?.parts?.[pt];

    if(!Array.isArray(list) || list.length===0){
      showResult(`<div class="result bad"><span class="badge bad">No interchange</span><div style="margin-top:8px">No list saved for <b>${pt}</b>.</div></div>`);
      return;
    }

    resultsEl.innerHTML = `
      <div class="result"><span class="badge">Found</span>
        <div style="margin-top:8px" class="small">${y} ${mk} ${md} • ${pt}</div>
      </div>
    `;
    list.forEach(item=>{
      const div = document.createElement("div");
      div.className = "result";
      div.textContent = item;
      resultsEl.appendChild(div);
    });
  }

  async function decodeVIN(){
    const v = (vinEl.value||"").trim().toUpperCase();
    if(v.length !== 17){
      toast("Enter a 17-digit VIN");
      return;
    }

    showResult(`<div class="result"><span class="badge">Decoding…</span><div style="margin-top:8px">Looking up VIN with NHTSA.</div></div>`);

    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${v}?format=json`);
    const d = (await r.json()).Results?.[0] || {};

    const y = d.ModelYear ? String(d.ModelYear) : "";
    const mk = d.Make ? titleCaseKeepDigits(d.Make) : "";
    const md = d.Model ? titleCaseKeepDigits(d.Model) : "";

    if(!y || !mk || !md){
      showResult(`<div class="result bad"><span class="badge bad">Decode failed</span><div style="margin-top:8px">Year/Make/Model missing from VIN response.</div></div>`);
      return;
    }

    yearEl.value = y;
    await loadMakes();
    makeEl.value = mk;
    await loadModels();
    modelEl.value = md;

    showResult(`<div class="result"><span class="badge">VIN OK</span><div style="margin-top:8px">${y} ${mk} ${md}</div></div>`);
  }

  function ensureAdmin(){
    const ok = localStorage.getItem("jb_admin_ok") === "1";
    if(ok){
      adminBody.classList.remove("locked");
      adminLockedNote.style.display = "none";
    }else{
      adminBody.classList.add("locked");
      adminLockedNote.style.display = "block";
    }
    return ok;
  }

  async function saveVehiclePart(){
    if(!ensureAdmin()){
      toast("Admin locked");
      return;
    }

    const y = Number((ayear.value||"").trim());
    const mk = titleCaseKeepDigits(amake.value);
    const md = titleCaseKeepDigits(amodel.value);
    const pt = (apart.value||"").trim();

    const lines = (ainterchange.value||"")
      .split("\n")
      .map(s=>s.trim())
      .filter(Boolean);

    if(!y || !mk || !md || !pt || lines.length===0){
      toast("Fill all admin fields");
      return;
    }

    const id = vehicleId(y, mk, md);
    const ref = doc(db, "vehicles", id);
    const snap = await getDoc(ref);

    const newPartMap = { [pt]: lines };

    if(!snap.exists()){
      await setDoc(ref, { year:y, make:mk, model:md, parts:newPartMap });
    }else{
      const existing = snap.data() || {};
      const parts = existing.parts || {};
      parts[pt] = lines;
      await updateDoc(ref, { parts, year:y, make:mk, model:md });
    }

    toast("Saved ✅");

    // Also set the search inputs to what you just saved
    yearEl.value = String(y);
    await loadMakes();
    makeEl.value = mk;
    await loadModels();
    modelEl.value = md;
    partEl.value = pt;

    await loadYears();
  }

  async function seedExample(){
    if(!ensureAdmin()){
      toast("Admin locked");
      return;
    }

    ayear.value = "2018";
    amake.value = "Ford";
    amodel.value = "F150";
    apart.value = "Engine";
    ainterchange.value = [
      "2018–2020 Ford F150 5.0L",
      "2017–2019 Ford Expedition 5.0L",
      "2018–2021 Ford Mustang 5.0L"
    ].join("\n");
    await saveVehiclePart();

    ayear.value = "2020";
    amake.value = "Toyota";
    amodel.value = "Camry";
    apart.value = "Battery";
    ainterchange.value = [
      "2018–2023 Toyota Camry battery group",
      "2019–2022 Toyota RAV4 battery"
    ].join("\n");
    await saveVehiclePart();

    toast("Seeded ✅");
  }

  function openAdmin(){
    adminModal.style.display = "flex";
    adminErr.style.display = "none";
    adminUser.value = "";
    adminPass.value = "";
    adminUser.focus();
  }
  function closeAdmin(){
    adminModal.style.display = "none";
  }
  function adminLogin(){
    const u = (adminUser.value||"").trim();
    const p = (adminPass.value||"").trim();
    if(u === ADMIN_USER && p === ADMIN_PASS){
      localStorage.setItem("jb_admin_ok", "1");
      adminErr.style.display = "none";
      closeAdmin();
      ensureAdmin();
      toast("Admin unlocked ✅");
      document.getElementById("adminCard").scrollIntoView({behavior:"smooth", block:"start"});
      return;
    }
    adminErr.style.display = "block";
  }
  function adminLogout(){
    localStorage.removeItem("jb_admin_ok");
    ensureAdmin();
    toast("Logged out");
  }

  // expose functions for buttons
  window.findInterchange = findInterchange;
  window.decodeVIN = decodeVIN;
  window.saveVehiclePart = saveVehiclePart;
  window.seedExample = seedExample;
  window.openAdmin = openAdmin;
  window.closeAdmin = closeAdmin;
  window.adminLogin = adminLogin;
  window.adminLogout = adminLogout;

  // input events (type-as-you-go suggestions)
  yearEl.addEventListener("input", loadMakes);
  makeEl.addEventListener("input", loadModels);

  // close modal on background click
  adminModal.addEventListener("click", (e)=>{
    if(e.target === adminModal) closeAdmin();
  });

  // init
  await ping();
  await loadYears();
  ensureAdmin();
</script>

</body>
</html>
